<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel É Os Pé Na Porta</title>
  <style>
    :root{
      --bg:#07070b;--card:#0f0f16;--line:#26263a;--text:#f4f4ff;--muted:#bdbdd8;
      --red:#ff1e1e;--red2:#b80000;--shadow:0 18px 60px rgba(0,0,0,.55);--r:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(900px 520px at 20% -10%, rgba(255,30,30,.18), transparent 55%),var(--bg);
      color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:18px}
    .wrap{max-width:1100px;margin:0 auto}
    .top{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:12px}
    h1{margin:0;font-size:22px}
    .sub{margin:6px 0 0;color:var(--muted);font-size:13px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.10);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .bar{display:flex;gap:10px;flex-wrap:wrap;padding:12px;border-bottom:1px solid rgba(255,255,255,.08)}
    input{background:#0c0c13;border:1px solid rgba(255,255,255,.10);border-radius:12px;color:var(--text);
      padding:10px 12px;min-width:260px;outline:none}
    input:focus{border-color:rgba(255,30,30,.45);box-shadow:0 0 0 4px rgba(255,30,30,.10)}
    button{border:none;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
    .btn{background:var(--red);color:#111}
    .btn2{background:transparent;border:1px solid rgba(255,255,255,.14);color:var(--text)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;padding:12px}
    @media(min-width:980px){.grid{grid-template-columns:1.2fr .8fr}}
    .list{padding:12px}
    .row{border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:12px;margin-bottom:10px;background:rgba(0,0,0,.22)}
    .rowTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .tag{font-weight:900}
    .meta{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.35}
    .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .ok{background:#31d158;color:#101}
    .no{background:#ff4d4d;color:#101}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);font-size:12px;color:var(--muted)}
    .right{padding:12px}
    .box{border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(0,0,0,.20);padding:12px}
    .box h3{margin:0 0 8px 0;font-size:14px}
    .small{color:var(--muted);font-size:12px;line-height:1.4}
    a{color:var(--red)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Painel É Os Pé Na Porta</h1>
        <div class="sub">Aprovação manual • Tema vermelho/preto • Bot aplica cargo em até 3s</div>
      </div>
      <span class="pill" id="statusPill">offline</span>
    </div>

    <div class="card">
      <div class="bar">
        <input id="apiKey" type="password" placeholder="Cole aqui a SITE_API_KEY (admin)"/>
        <button class="btn" onclick="loadAll()">Atualizar</button>
        <button class="btn2" onclick="logout()">Limpar</button>
      </div>

      <div class="grid">
        <div class="list">
          <div id="list"></div>
        </div>
        <div class="right">
          <div class="box">
            <h3>Config</h3>
            <div class="small">
              • Esta dashboard usa a mesma chave <b>SITE_API_KEY</b> do bot.<br/>
              • Aprovar/recusar muda o status no banco.<br/>
              • O bot (ShardCloud) faz polling a cada <b>3s</b> e aplica o cargo.<br/>
              • Link do formulário: vem do comando <b>/form</b> no Discord.<br/>
              <br/>
              Voltar: <a href="/">Home</a>
            </div>
          </div>
          <div style="height:12px"></div>
          <div class="box">
            <h3>Atualizar Link do Bonde</h3>
            <div class="small">Salva no banco (usado como padrão no form).</div>
            <div style="height:8px"></div>
            <input id="linkInput" placeholder="https://www.roblox.com/share/g/1003923644"/>
            <div style="height:8px"></div>
            <button class="btn" onclick="saveLink()">Salvar</button>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
  const pill = document.getElementById("statusPill");
  const list = document.getElementById("list");
  const apiKeyInput = document.getElementById("apiKey");
  const linkInput = document.getElementById("linkInput");

  apiKeyInput.value = localStorage.getItem("SITE_API_KEY") || "";

  function authHeaders(){
    const k = apiKeyInput.value.trim();
    return { "Authorization": "Bearer " + k, "Content-Type":"application/json" };
  }

  function setStatus(ok){
    pill.textContent = ok ? "online" : "offline";
    pill.style.borderColor = ok ? "rgba(49,209,88,.35)" : "rgba(255,77,77,.35)";
    pill.style.background = ok ? "rgba(49,209,88,.08)" : "rgba(255,77,77,.08)";
    pill.style.padding = "6px 10px";
    pill.style.borderRadius = "999px";
    pill.style.border = "1px solid";
  }

  async function loadAll(){
    const k = apiKeyInput.value.trim();
    if(!k){ alert("Cole a SITE_API_KEY"); return; }
    localStorage.setItem("SITE_API_KEY", k);

    try{
      const health = await fetch("/api?op=health");
      setStatus(health.ok);

      const r = await fetch("/api?op=listPending", { headers: authHeaders() });
      if(!r.ok){ const t=await r.text(); throw new Error(t); }
      const data = await r.json();

      const cfg = await fetch("/api?op=getConfig", { headers: authHeaders() }).then(r=>r.json());
      linkInput.value = cfg?.defaultLink || "";

      render(data);
    }catch(e){
      setStatus(false);
      list.innerHTML = "<div class='small'>❌ Erro: " + (e.message||e) + "</div>";
    }
  }

  function render(items){
    if(!items || !items.length){
      list.innerHTML = "<div class='small'>Sem formulários pendentes.</div>";
      return;
    }
    list.innerHTML = items.map(it => `
      <div class="row">
        <div class="rowTop">
          <div>
            <div class="tag">${escapeHtml(it.discordTag || "Usuário")} <span class="pill">${it.status}</span></div>
            <div class="meta">
              <b>Nick:</b> ${escapeHtml(it.nick)}<br/>
              <b>Idade:</b> ${escapeHtml(String(it.idade))}<br/>
              <b>Motivo:</b> ${escapeHtml(it.motivo)}<br/>
              <b>Link:</b> <a href="${escapeAttr(it.linkBonde)}" target="_blank">abrir</a><br/>
              <b>Enviado:</b> ${new Date(Number(it.createdAt)).toLocaleString()}
            </div>
          </div>
          <div class="actions">
            <button class="ok" onclick="decide('${it.token}','APPROVED')">✅ Aprovar</button>
            <button class="no" onclick="decide('${it.token}','REJECTED')">❌ Recusar</button>
          </div>
        </div>
      </div>
    `).join("");
  }

  async function decide(token, decision){
    if(!confirm((decision==='APPROVED'?'Aprovar':'Recusar') + " este formulário?")) return;
    const r = await fetch("/api?op=staffDecision", {
      method:"POST",
      headers: authHeaders(),
      body: JSON.stringify({ token, decision, staffId: "dashboard" })
    });
    if(!r.ok){ alert("Erro: " + await r.text()); return; }
    await loadAll();
    alert("✅ OK. O bot aplica o cargo em até 3s (se aprovado).");
  }

  async function saveLink(){
    const link = linkInput.value.trim();
    const r = await fetch("/api?op=setConfig", {
      method:"POST",
      headers: authHeaders(),
      body: JSON.stringify({ defaultLink: link })
    });
    if(!r.ok){ alert("Erro: " + await r.text()); return; }
    alert("✅ Link salvo!");
  }

  function logout(){
    localStorage.removeItem("SITE_API_KEY");
    apiKeyInput.value = "";
    list.innerHTML = "<div class='small'>Chave removida.</div>";
    setStatus(false);
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  }
  function escapeAttr(s){
    return String(s||"").replace(/"/g,"%22");
  }

  loadAll();
</script>
</body>
</html>
