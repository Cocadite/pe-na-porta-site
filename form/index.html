<script>
  const API_BASE = "https://api-pe-na-porta.vercel.app";
  const params = new URLSearchParams(location.search);
  const token = (params.get("token") || "").trim();

  document.getElementById("tok").textContent = token || "sem token";

  function showErr(msg){
    document.getElementById("errText").textContent = msg;
    document.getElementById("alertErr").style.display = "block";
    document.getElementById("alertOk").style.display = "none";
  }

  function showOk(){
    document.getElementById("alertOk").style.display = "block";
    document.getElementById("alertErr").style.display = "none";
  }

  async function submitForm(ev){
    ev.preventDefault();

    const idade = Number(document.getElementById("idade").value);
    const nick = document.getElementById("nick").value.trim();
    const motivo = document.getElementById("motivo").value.trim();
    const link = document.getElementById("linkBonde").value.trim();
    const discordTag = document.getElementById("discordTag").value.trim();

    if (!token) return showErr("Token ausente. Peça /form de novo."), false;
    if (!nick) return showErr("Preencha o Nick."), false;
    if (!motivo || motivo.length < 10) return showErr("Explique melhor (mínimo 10 caracteres)."), false;
    if (!Number.isFinite(idade) || idade < 5 || idade > 120) return showErr("Idade inválida."), false;
    if (!/^https?:\/\//i.test(link)) return showErr("Link do bonde inválido."), false;

    try{
      const res = await fetch(API_BASE + "/form/submit", {
        method:"POST",
        headers:{
          "Content-Type":"application/json"
        },
        body: JSON.stringify({
          token,
          discordTag,
          nick,
          idade,
          motivo,
          linkBonde: link
        })
      });

      const data = await res.json().catch(()=> ({}));
      if(!res.ok) throw new Error(data.error || ("HTTP " + res.status));

      showOk();
      return false;

    }catch(e){
      showErr(e.message || "Falha ao enviar.");
      return false;
    }
  }

  function fillExample(){
    document.getElementById("idade").value = "16";
    document.getElementById("nick").value = "Arroz_macio";
    document.getElementById("motivo").value = "Quero me juntar porque curto o bonde, sou ativo e quero evoluir com a galera.";
  }
                                               </script>
